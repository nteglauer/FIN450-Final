---
title: "FIN450 Final Assignment"
output: html_document
date: "2023-11-24"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Libraries}
library(tidyverse)
library(RSelenium)
library(netstat)
library(jsonlite)
library(robotstxt)
library(rvest)

```

```{r remDr Start}
# Start the server
rs_driver_object <- rsDriver(browser = "firefox",
                             chromever = NULL,
                             verbose = FALSE
                             )

# Create a Client object
remDr <- rs_driver_object$client
```

```{r Revenue For the top 200 movies of each year from 2024 - num_pages}

#Scrapes the revenue of each movie flipping through each year.
scrape_revenue_data <- function(num_pages) {
  all_data <- list()  # Initialize an empty list to store the collected data

  for (page in 1:(num_pages)) {
    # Click the year drop down
    drop_down <- remDr$findElement(using = 'css selector', '.mojo-refinement')$clickElement()
    remDr$findElement(using = 'css selector',  paste0('li.a-dropdown-item:nth-child(', page, ')'))$clickElement()
    
    # Pause
    Sys.sleep(1)
    
    # Read the HTML of the current page
    url <- as.character(remDr$getCurrentUrl())
    webpage <- read_html(url)
    
    # Extract the table data 
    table_data <- webpage %>% 
      html_nodes("#table table") %>% 
      html_table(fill = TRUE)
    
    # Add the "Year" column
    table_data <- lapply(table_data, function(df) { df$Year <- 2024 - page; return(df) })
    
    # Add the data to the overall list
    all_data <- c(all_data, list(table_data))
  }
  
  return(all_data)
}

```

```{r Extract Movie Specific Data}

#Scrapes the Movie specific data, returns a wide df of the movie's data
extract_movie_data <- function(webpage, title) {
  # Target the specific div that contains the table rows
  table_nodes <- webpage %>% 
    html_nodes(".mojo-summary-values .a-section.a-spacing-none")
  
  # Initialize empty lists to store headers and values
  headers <- c()
  values <- c()
  
  # Iterate through each table row
  for (node in table_nodes) {
    # Extract the header
    header <- node %>% html_node("span:nth-child(1)") %>% html_text()
    
    # Extract the value
    value_node <- node %>% html_node("span:nth-child(2)")
    value <- value_node %>% html_text(trim = TRUE)
    
    # Append the header and value to the lists
    headers <- c(headers, header)
    values <- c(values, value)
  }
  
  # Combine headers and values into a data frame
  table_data <- data.frame(Header = headers, Value = values)
  table_data$Title <- title
  df_wide <- table_data %>% 
    tidyr::pivot_wider(names_from = Header, values_from = Value)
  
  return(df_wide)
}

```

```{r Main Scraper}

# Flips through each Movie within each Year and aggregates the specific year's movie data
scrape_movie_data <- function(movie_titles) {
  movie_df <- tibble()
  for (title in movie_titles) {
    # Find and click the link for the current movie title
    address <- as.character(remDr$getCurrentUrl())
    movie_link <- remDr$findElement(using = 'link text', title)$clickElement()
    
    remDr$findElement(using = 'link text', 'Title Summary')$clickElement()
    remDr$findElement(using = 'link text', 'Cast and Crew')$clickElement()
    
    url <- as.character(remDr$getCurrentUrl())
    webpage <- read_html(url)
    movie_data <- extract_movie_data(webpage, title)
    
    # Append the movie_data to the global movie_df
    movie_df <- bind_rows(movie_df, movie_data)
    
    remDr$navigate(address)
    
    # Pause
    Sys.sleep(1)
  }
  return(movie_df)
}

```

```{r Scrape and Aggregate data}

#Flips through each year and aggregates all year's data
scrape_and_aggregate_data <- function(num_pages, movies_per_page, movie_titles) {
  # Initialize an empty data frame to store aggregated movie data
  final_df <- tibble()
  
  for (page in 1:num_pages) {
    # Calculate the start and end indices for the current page
    start_index <- (page - 1) * movies_per_page + 1
    end_index <- page * movies_per_page
    
    # Extract movie titles for the current page
    current_page_titles <- movie_titles[start_index:end_index]
    
    # Scrape movie specific data
    movie_df <- scrape_movie_data(current_page_titles)
    final_df <- bind_rows(final_df, movie_df)
    
    # Click the year drop down
    drop_down <- remDr$findElement(using = 'css selector', '.mojo-refinement')$clickElement()
    remDr$findElement(using = 'css selector', paste0('li.a-dropdown-item:nth-child(', page + 1, ')'))$clickElement()
    
    # Pause
    Sys.sleep(1)
  }
  
  return(final_df)
}
```

```{r MAIN}
website <- 'https://www.boxofficemojo.com/'
remDr$open()
remDr$navigate(website)
alltime <- remDr$findElement(using = 'link text', 'Worldwide')$clickElement()

#RUN EVERYTHING UNDER HERE TO TEST 

#CHANGE AS NEEDED
num_pages <- 25 
movies_per_page <- 100

# Collect Revenue data
result_data <- scrape_revenue_data(num_pages)
rev_df <- bind_rows(result_data)
rev_df$`Release Group` <- gsub("\\s{2,}(Re-release)", " \\1", rev_df$`Release Group`)
rev_df <- rev_df %>% 
  dplyr::filter(Rank <= movies_per_page)

rev_df

movie_titles <- rev_df$`Release Group`

# Return to first page
drop_down <- remDr$findElement(using = 'css selector', '.mojo-refinement')$clickElement()
remDr$findElement(using = 'css selector',  paste0('li.a-dropdown-item:nth-child(1)'))$clickElement()


movie_df <- scrape_and_aggregate_data(num_pages, movies_per_page, movie_titles)

movie_df

```

```{r scraping new release}
library(rvest)
library(stringr)
library(dplyr)
library(tidyr)

# Replace 'your_url_here' with the actual URL of the webpage
url <- "https://www.imdb.com/calendar/?ref_=rlm&region=US&type=MOVIE"

# Read the HTML content of the webpage
webpage <- read_html(url)

# Use the identified CSS selector for the movie elements
movie_elements <- html_nodes(webpage, '.ipc-metadata-list-summary-item')

# Initialize an empty list to store data for each movie
movies_data <- list()

# Loop through each movie element
for (i in seq_along(movie_elements)) {
  # Extract title
  title <- html_text(html_node(movie_elements[[i]], '.ipc-metadata-list-summary-item__t'))

  # Extract year (assuming it's within the title link)
  year <- gsub("[^0-9]", "", str_match(title, "\\((\\d{4})\\)")[, 2])

  # Extract genres
  genres <- html_text(html_nodes(movie_elements[[i]], '.ipc-inline-list--show-dividers.ipc-metadata-list-summary-item__tl .ipc-inline-list__item'))

  # Extract stars
  stars <- html_text(html_nodes(movie_elements[[i]], '.ipc-inline-list--show-dividers.ipc-metadata-list-summary-item__stl .ipc-inline-list__item'))

  # Store the data for the current movie in a list
  movie_data <- list(title = title, year = year, genres = paste(genres, collapse = ", "), stars = paste(stars, collapse = ", "))

  # Append the list to the movies_data list
  movies_data <- append(movies_data, list(movie_data))
}

# Convert the list of lists into a data frame
movies_df <- bind_rows(movies_data)

# Print the resulting data frame
print(movies_df)

```

```{r import economic data}

library(tidyr)
library(tidyquant)
library(dplyr)

# Set get ="economic.data" in tq_get()
import_economic_data <- tidyquant::tq_get(c("DPCCRV1Q225SBEA", "UNRATE", "DGS10"),
                                         get  = "economic.data",
                                         from = "1990-01-01",
                                         to   = Sys.Date()) %>% 
  dplyr::mutate(symbol = dplyr::case_when(symbol == "DPCCRV1Q225SBEA" ~ "Consumer Spending % (USA)",
                                          symbol == "UNRATE" ~ "Unemployment Rate % (USA)",
                                          symbol == "DGS10" ~ "U.S Treasury Yield "))

economic_data <- import_economic_data %>%
  tidyr::pivot_wider(names_from = symbol, values_from = price) %>%
  tidyr::complete(date = seq.Date(from = min(date), to = max(date), by = "1 month")) %>%
  dplyr::arrange(date)

economic_data # df that includes Consumer Spending, Unemployment Rate, and Fed Funds Rate in the United States with aligned dates


theatre_stocks <- tidyquant::tq_get(
  c("IMAX", "CGX", "SPY"),
  get  = "stock.prices",
) %>%
  dplyr::transmute(date, series = symbol, value = adjusted) %>%
  dplyr::group_by(series) %>%
  dplyr::mutate(
    ret = log(value / dplyr::lag(value))
  ) %>%
  dplyr::select(-value) %>%
  tidyr::pivot_wider(names_from = series, values_from = ret) %>%
  tidyr::drop_na()


theatre_stocks #includes returns daily for IMAX and Cineplex stocks


```
