---
title: "FIN450 Final Assignment"
output: html_document
date: "2023-11-24"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Potential Ideas:

Job Market Analysis
Hotel Booking Cancellation Prediction
Movie Revenue Generation
Video Game Trends and Sales
Disease Outbreak Prediction

Crime Incidents Across Canada (USA?)

- Web scrape all crime reports from the past 10 years 
- Import data into dfs
- Analyse data based on underlying influence (Interest Rates, Weather, Housing Prices, Lunar Phases, proximity of fast food restraints, trees, government in power, number of social programs)
- Build a report that discusses the influence of these factors, which ones are the most prominent, and our proposed solution.


```{r Libraries}
library(tidyverse)
library(RSelenium)
library(netstat)
library(jsonlite)
library(robotstxt)
library(rvest)

```

```{r remDr Start}
# Start the server
rs_driver_object <- rsDriver(browser = "firefox",
                             chromever = NULL,
                             verbose = FALSE
                             )

# Create a Client object
remDr <- rs_driver_object$client
```
 
```{r imdb Scraping WIP}

# Website to navigate
website <- 'https://www.imdb.com/search/title/'

# Open a browser
remDr$open()

# Navigate to website
remDr$navigate(website)

titletype <- remDr$findElement(using = "id", value = "titleTypeAccordion")$clickElement()

movie_filter_button <- remDr$findElement(using = "xpath", value = "//button[contains(@data-testid, 'test-chip-id-movie')]")$clickElement()

awards <- remDr$findElement(using = "id", value = "awardsAccordion")$clickElement()

top_1000_button <- remDr$findElement(using = "xpath", value = "//button[contains(@data-testid, 'test-chip-id-top-1000')]")$clickElement()

results_button <- remDr$findElement(using = "xpath", value = "//button[contains(@data-testid, 'adv-search-get-results')]")$clickElement()

# Click the "See more info" button for all movies
info_buttons <- remDr$findElements(using = "xpath", value = "//button[contains(@class, 'ipc-icon-button') and contains(@class, 'dli-info-icon')]")
for (button in info_buttons) {
  button$clickElement()
  

  Sys.sleep(2)
  
  # Close the info tab
  close_button <- remDr$findElement(using = "xpath", value = "//div[contains(@class, 'ipc-promptable-base__close')]//button[@title='Close Prompt']")
  close_button$clickElement()
}


```

```{r Revenue For the top 1000 movies}
website <- 'https://www.boxofficemojo.com/'
remDr$open()
remDr$navigate(website)
alltime <- remDr$findElement(using = 'link text', 'Worldwide')$clickElement()


scrape_movie_data <- function(num_pages = 25) {
  all_data <- list()  # Initialize an empty list to store the collected data

  for (page in 1:(num_pages)) {
    # Click the year drop down
    drop_down <- remDr$findElement(using = 'css selector', '.mojo-refinement')$clickElement()
    remDr$findElement(using = 'css selector',  paste0('li.a-dropdown-item:nth-child(', page, ')'))$clickElement()
    
    # Pause
    Sys.sleep(1)
    
    # Read the HTML of the current page
    url <- as.character(remDr$getCurrentUrl())
    webpage <- read_html(url)
    
    # Extract the table data 
    table_data <- webpage %>% 
      html_nodes("#table table") %>% 
      html_table(fill = TRUE)
    
    # Add the "Year" column
    table_data <- lapply(table_data, function(df) { df$Year <- 2024 - page; return(df) })
    
    # Add the data to the overall list
    all_data <- c(all_data, list(table_data))
  }

  return(all_data)
}

result_data <- scrape_movie_data(num_pages = 25)

rev_df <- bind_rows(result_data)
rev_df$`Release Group` <- gsub("\\s{2,}(Re-release)", " \\1", rev_df$`Release Group`)
rev_df <- rev_df %>% 
  dplyr::filter(Rank <= 100)

rev_df


```

```{r}
click_movie_links <- function(movie_titles) {
  for (title in movie_titles) {
    # Find and click the link for the current movie title
    movie_link <- remDr$findElement(using = 'link text', title)$clickElement()
    
    remDr$goBack()
    
    # Pause
    Sys.sleep(1)
  }
}

movie_titles <- rev_df$`Release Group`
num_pages <- 25
movies_per_page <- 100

# Iterate through each page
for (page in 1:(num_pages)) {
  # Calculate the start and end indices for the current page
  start_index <- (page - 1) * movies_per_page + 1
  end_index <- page * movies_per_page
  
  # Extract movie titles for the current page
  current_page_titles <- movie_titles[start_index:end_index]
  
  # Click the embedded link for each movie title and go back
  click_movie_links(current_page_titles)
  
  # Click the year drop down
  drop_down <- remDr$findElement(using = 'css selector', '.mojo-refinement')$clickElement()
  remDr$findElement(using = 'css selector',  paste0('li.a-dropdown-item:nth-child(', page + 1, ')'))$clickElement()
  
  # Pause
  Sys.sleep(1)
}

```


